<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<title>Embed Qlik Sense com Web Integration</title>
<style>
  body { font-family: Arial, sans-serif; margin: 40px; }
  iframe { width: 100%; height: 900px; border: none; margin-top: 20px; }
  #status { margin-top: 20px; }
</style>
</head>
<body>
<h1>Embed Qlik Sense (sem 302)</h1>
<button onclick="connectAndEmbed()">Carregar App</button>
<div id="status"></div>
<iframe id="qlikApp" style="display:none;"></iframe>
 
<script>
const tenant = "keyruspt.eu.qlikcloud.com"; // teu tenant
const webIntegrationId = "F5lgGsalXWNob9SEj1n-PuH-l93y9Ojk"; // teu Web Integration ID
const appId = "2600467e-7e6c-4c36-9fb4-2139caa1cb4d"; // tua app
const sheetId = "pwn"; // opcional
 
async function connectAndEmbed() {
    document.getElementById("status").innerText = "A autenticar...";
    try {
        // Tenta autenticar ou criar sessão anónima
        const resp = await fetch(`https://${tenant}/api/v1/users/me`, {
            method: "GET",
            credentials: "include",
            headers: { "qlik-web-integration-id": webIntegrationId }
        });
 
        if (!resp.ok) {
            throw new Error(`Falha na autenticação: ${resp.status}`);
        }
 
        const userData = await resp.json();
        console.log("Sessão Qlik:", userData);
        document.getElementById("status").innerText = "Sessão criada. Carregando aplicação...";
 
        // Carrega o iframe já com a sessão válida
        const iframeUrl = `https://${tenant}/single/?appid=${appId}&sheet=${sheetId}&opt=ctxmenu,currsel&theme=classic`;
        const iframe = document.getElementById("qlikApp");
        iframe.src = iframeUrl;
        iframe.style.display = "block";
 
    } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = `Erro: ${err.message}`;
    }
}
</script>
</body>
</html>
